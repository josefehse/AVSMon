{
    "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "AVS Monitoring Solution",
            "steps": [
                {
                    "name": "basics",
                    "label": "Basics",
                    "elements": [
                        {
                            "name": "resourceScope",
                            "type": "Microsoft.Common.ResourceScope",
                            "instanceDetailsLabel": "AVS Mon Deployment Details"
                        },
						{
                            "name": "subscriptionAPI",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "subscriptions?api-version=2022-12-01"
                            }
                        }
                    ]
                },
				{
					"name": "Configuration",
					"label": "Configuration",
					"elements": [
						{
							"name": "AppInsightsLocationsAPI",
							"type": "Microsoft.Solutions.ArmApiControl",
							"request": {
								"method": "GET",
								"path": "[concat(steps('basics').resourceScope.subscription.id,'/providers/microsoft.insights?api-version=2014-04-01-preview')]",
								"transforms": {
									"list": "resourceTypes[?resourceType == 'components/operations'].locations[].{label: @, value: @}"
								}
							}
						},
                        {
                            "name": "instanceName",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Instance Name for the AVS Mon to be used as a prefix.",
                            "subLabel": "",
                            "defaultValue": "avsmon",
                            "toolTip": "Instance Name for the AVS Mon to be used as a prefix.",
                            "constraints": {
								"required": true,
                    			"regex": "^[a-z0-9]{1,8}$",
                    			"validationMessage": "Only alphanumeric lowercase characters are allowed, and the value must be 1-8 characters long."
                            },
                            "visible": true
                        },
						{
                            "name": "virtualNetworkSelection",
                            "type": "Microsoft.Solutions.ResourceSelector",
                            "visible": "true",
                            "label": "Virtual network",
                            "resourceType": "Microsoft.Network/virtualNetworks"

                        },
                        {
                            "name": "subnetsApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "GET",
                                "path": "[concat(steps('Configuration').virtualNetworkSelection.id, '/subnets?api-version=2022-05-01')]"
                            }
                        },
                        {
                            "name": "subnet",
                            "type": "Microsoft.Common.DropDown",
                            "visible": "true",
                            "label": "Subnet",
                            "defaultValue": "",
                            "toolTip": "Select an existing subnet for AVS Mon deployment. The subnet will be used for vnet integration.",
                            "constraints": {
                                "allowedValues": "[map(steps('Configuration').subnetsApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]"
                            }
                        },
                        {
                            "name": "LAWStatus",
                            "type": "Microsoft.Common.OptionsGroup",
                            "label": "Use New or Existing Log Analytics Workspace",
                            "toolTip": "This will be the log analytics workspace from which data will be read and stored.",
                            "defaultValue": "Existing",
                            "constraints": {
                                "allowedValues": [
                                    {
                                        "label": "New",
                                        "value": "New"
                                    },
                                    {
                                        "label": "Existing",
                                        "value": "Existing"
                                    }
                                ],
                                "required": true
                            },
                            "visible": true
                        },
                        {
                            "name": "LogAnalyticsWorkspaceResourceNew",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Log Analytics Workspace Name for AVS Mon Packs",
                            "subLabel": "",
                            "defaultValue": "avsmon-LA",
                            "toolTip": "Log Analytics Workspace Name for AVS Mon.",
                            "constraints": {
                                "required": "[equals(steps('Configuration').LAWStatus, 'New')]",
                                "regex": "^[a-zA-Z0-9][a-zA-Z0-9-]{0,21}[a-zA-Z0-9]$",
                                "validationMessage": ""
                            },
                            "visible": "[equals(steps('Configuration').LAWStatus, 'New')]"
                        },
						{
                            "name": "logAnalyticsWorkspaceSelection",
                            "type": "Microsoft.Solutions.ResourceSelector",
                            "visible": "[equals(steps('Configuration').LAWStatus, 'Existing')]",
                            "label": "Log analytics workspace",
                            "resourceType": "Microsoft.OperationalInsights/workspaces",
                            "options": {}
                        },
						{
							"name": "storageAccountSelector",
							"type": "Microsoft.Storage.StorageAccountSelector",
							"label": "Storage account",
							"toolTip": "",
							"defaultValue": {
								"name": "storageaccount01",
								"type": "Standard_LRS"
							},
							"scope": {
								"location": "[steps('basics').resourceScope.location.name]",
								"resourceGroupName": "[steps('basics').resourceScope.resourcegroup.name]",
								"subscriptionId": "[last(split(steps('basics').resourceScope.subscription.id,'/'))]"
							},
							"constraints": {
								"allowedTypes": []
							},
							"options": {
								"hideExisting": false
							},
							"visible": true
						},
                        {
                            "name": "keyvaultname",
                            "type": "Microsoft.Common.TextBox",
                            "label": "KeyVault Name",
                            "subLabel": "",
                            "defaultValue": "avsmonkv",
                            "toolTip": "AVS Mon keyvault name.",
                            "constraints": {
								"required": true,
                    			"regex": "^[a-z0-9]{1,16}$",
                    			"validationMessage": "Only alphanumeric lowercase characters are allowed, and the value must be 1-16 characters long."
                            },
                            "visible": true
                        },
												{
							"name": "AppInsightsLocationsAPI",
							"type": "Microsoft.Solutions.ArmApiControl",
							"request": {
								"method": "GET",
								"path": "[concat(steps('basics').resourceScope.subscription.id,'/providers/microsoft.insights?api-version=2014-04-01-preview')]",
								"transforms": {
									"list": "resourceTypes[?resourceType == 'components/operations'].locations[].{label: @, value: @}"
								}
							}
						},
						{
							"name": "AppInsightsLocation",
							"type": "Microsoft.Common.DropDown",
							"label": "Location for App Insights",
							"multiselect": false,
							"defaultValue": "",
							"toolTip": "Subscription to deploy resources to.",
							"filter": true,
							"filterPlaceholder": "Filter Locations...",
							"defaultDescription": "A value for selection",
							"constraints": {
								"allowedValues": "[steps('Configuration').AppInsightsLocationsAPI.transformed.list]",
								"required": true
							},
							"visible": true
						},
                        {
							"name": "collectTelemetry",
							"type": "Microsoft.Common.CheckBox",
							"label": "Collect deployment telemetry.",
							"toolTip": "Microsoft can correlate these resources used to support the deployments. Microsoft collects this information to provide the best experiences with their products and to operate their business. The telemetry is collected through customer usage attribution. The data is collected and governed by Microsoft's privacy policies, located at https://www.microsoft.com/trustcenter.",
							"constraints": {
								"required": false,
								"validationMessage": "Please acknowledge the legal conditions."
							},
							"defaultValue": true
							
						}
					]
				},
                {
                    "name": "AVSConfiguration",
                    "label": "AVS Configuration",
                    "elements": [
                        {
                            "name": "avsNSXTAdmin",
                            "type": "Microsoft.Common.TextBox",
                            "label": "AVS NSXT Admin Name",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "",
                            "constraints": {
                                "required": true
                            },
                            "visible": true
                        },
                        {
                            "name": "avsNSXTAdminPassword",
                            "type": "Microsoft.Common.PasswordBox",
                            "label": "AVS NSXT Admin Password",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "",
                            "constraints": {
                                "required": true,
                                "secret": true
                            },
                            "visible": true
                        },
                        {
                            "name": "avsvCenterAdmin",
                            "type": "Microsoft.Common.TextBox",
                            "label": "AVS vCenter Admin Username",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "",
                            "constraints": {
                                "required": true
                            },
                            "visible": true
                        },
                        {
                            "name": "avsvCenterAdminPassword",
                            "type": "Microsoft.Common.PasswordBox",
                            "label": "AVS vCenter Admin Password",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "",
                            "constraints": {
                                "required": true
                            },
                            "visible": true
                        },
                        {
                            "name": "vCenterFQDN",
                            "type": "Microsoft.Common.TextBox",
                            "label": "vCenter FQDN (IP)",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "",
                            "constraints": {
                                "required": true
                            },
                            "visible": true
                        }
                    ]
                },
                
				{
                    "name": "tags",
                    "label": "Tags",
                    "elements": [
                        {
                            "name": "tagsByResource",
                            "type": "Microsoft.Common.TagsByResource",
                            "resources": [
                                "All"
                            ]
                        }
                    ]
                }
			]
		},
        "outputs": {
            "parameters": {
				"storageAccountName" : "[steps('Configuration').storageAccountSelector.name]",
				"location": "[steps('basics').resourceScope.location.name]",
				"functionname": "[concat(steps('Configuration').instanceName,'-','function')]",
				"keyvaultName": "[steps('Configuration').keyvaultname]",
				"vnetId": "[steps('Configuration').virtualNetworkSelection.id]",
                "subnetId": "[concat(steps('Configuration').virtualNetworkSelection.id, '/subnets/', steps('Configuration').subnet.value)]",
                "collectTelemetry": "[steps('Configuration').collectTelemetry]",
                "createNewLogAnalyticsWS": "[equals(steps('Configuration').LAWStatus, 'New')]",
                "createNewStorageAccount": "[equals(steps('Configuration').storageAccountSelector.newOrExisting,'new')]",	
				"logAnalyticsWorkspaceName": "[if(equals(steps('Configuration').LAWStatus, 'Existing'),steps('Configuration').logAnalyticsWorkspaceSelection.name,steps('Configuration').LogAnalyticsWorkspaceResourceNew)]",
				"appInsightsLocation" : "[steps('Configuration').AppInsightsLocation.value]",
                "avsNSXTAdmin": "[steps('AVSConfiguration').avsNSXTAdmin]",
                "avsNSXTAdminPassword": "[steps('AVSConfiguration').avsNSXTAdminPassword]",
                "avsvCenterAdmin": "[steps('AVSConfiguration').avsvCenterAdmin]",
                "avsvCenterAdminPassword": "[steps('AVSConfiguration').avsvCenterAdminPassword]",
                "vCenterFQDN": "[steps('AVSConfiguration').vCenterFQDN]",
                "Tags": "[steps('tags').tagsByResource]"
			},
			"kind": "ResourceGroup",
            "location": "[steps('basics').resourceScope.location.name]",
            "resourceGroupId": "[steps('basics').resourceScope.resourcegroup.id]"
            
		}
	}
}
